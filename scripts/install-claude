#!/bin/bash
# Claude Code - Instalador automático desde dotfiles
# Uso: ~/.dotfiles/scripts/install-claude

set -e

GREEN='\033[0;32m'
RED='\033[0;31m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

DOTFILES_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"

echo -e "${BLUE}"
cat << "EOF"
╔═══════════════════════════════════════════════════════════════╗
║      CLAUDE CODE - INSTALADOR AUTOMÁTICO DESDE DOTFILES      ║
╚═══════════════════════════════════════════════════════════════╝
EOF
echo -e "${NC}"

# Verificar que estamos en dotfiles
if [[ ! -d "$DOTFILES_DIR/claude" ]]; then
    echo -e "${RED}[✗]${NC} Error: No se encontró configuración de Claude en dotfiles"
    echo "    Ejecuta este script desde: ~/.dotfiles/scripts/install-claude"
    exit 1
fi

echo -e "${GREEN}[+]${NC} Instalando Claude Code desde dotfiles..."
echo ""

# 1. Verificar/Instalar dependencias
echo -e "${YELLOW}[1/6]${NC} Verificando dependencias..."

MISSING_DEPS=()

command -v docker &>/dev/null || MISSING_DEPS+=("docker")
command -v docker-compose &>/dev/null || MISSING_DEPS+=("docker-compose")
command -v node &>/dev/null || MISSING_DEPS+=("nodejs")
command -v npm &>/dev/null || MISSING_DEPS+=("npm")
command -v jq &>/dev/null || MISSING_DEPS+=("jq")

if [ ${#MISSING_DEPS[@]} -gt 0 ]; then
    echo -e "${YELLOW}[!]${NC} Faltan dependencias: ${MISSING_DEPS[*]}"
    echo -e "${YELLOW}[!]${NC} Instalando con pacman..."
    sudo pacman -S --needed --noconfirm "${MISSING_DEPS[@]}"
else
    echo -e "${GREEN}[✓]${NC} Todas las dependencias instaladas"
fi

# 2. Habilitar Docker
echo -e "${YELLOW}[2/6]${NC} Configurando Docker..."
if ! systemctl is-active --quiet docker; then
    sudo systemctl enable --now docker
    sudo usermod -aG docker "$USER"
    echo -e "${GREEN}[✓]${NC} Docker habilitado"
    echo -e "${YELLOW}[!]${NC} Necesitas cerrar sesión y volver a entrar para que Docker funcione sin sudo"
else
    echo -e "${GREEN}[✓]${NC} Docker ya está activo"
fi

# 3. Crear symlinks
echo -e "${YELLOW}[3/6]${NC} Creando symlinks..."

# Claude config
if [[ -L "$HOME/.config/claude" ]]; then
    echo -e "${GREEN}[✓]${NC} Symlink de Claude config ya existe"
elif [[ -d "$HOME/.config/claude" ]]; then
    echo -e "${YELLOW}[!]${NC} Directorio ~/.config/claude existe, respaldando..."
    mv "$HOME/.config/claude" "$HOME/.config/claude.bak"
    ln -sf "$DOTFILES_DIR/claude" "$HOME/.config/claude"
    echo -e "${GREEN}[✓]${NC} Symlink de Claude config creado"
else
    ln -sf "$DOTFILES_DIR/claude" "$HOME/.config/claude"
    echo -e "${GREEN}[✓]${NC} Symlink de Claude config creado"
fi

# SearXNG
if [[ -L "$HOME/searxng" ]]; then
    echo -e "${GREEN}[✓]${NC} Symlink de SearXNG ya existe"
elif [[ -d "$HOME/searxng" ]]; then
    echo -e "${YELLOW}[!]${NC} Directorio ~/searxng existe, respaldando..."
    mv "$HOME/searxng" "$HOME/searxng.bak"
    ln -sf "$DOTFILES_DIR/searxng" "$HOME/searxng"
    echo -e "${GREEN}[✓]${NC} Symlink de SearXNG creado"
else
    ln -sf "$DOTFILES_DIR/searxng" "$HOME/searxng"
    echo -e "${GREEN}[✓]${NC} Symlink de SearXNG creado"
fi

# Scripts
mkdir -p "$HOME/.local/bin"

for script in searxng-search claude-backup claude-check; do
    if [[ -L "$HOME/.local/bin/$script" ]]; then
        echo -e "${GREEN}[✓]${NC} Symlink de $script ya existe"
    else
        ln -sf "$DOTFILES_DIR/scripts/$script" "$HOME/.local/bin/$script"
        chmod +x "$DOTFILES_DIR/scripts/$script"
        echo -e "${GREEN}[✓]${NC} Symlink de $script creado"
    fi
done

# 4. Configurar systemd para SearXNG
echo -e "${YELLOW}[4/6]${NC} Configurando auto-inicio de SearXNG..."

mkdir -p "$HOME/.config/systemd/user"

cat > "$HOME/.config/systemd/user/searxng.service" << 'EOFSERVICE'
[Unit]
Description=SearXNG Metasearch Engine

[Service]
Type=oneshot
RemainAfterExit=yes
WorkingDirectory=%h/searxng
ExecStart=/usr/bin/docker-compose up -d
ExecStop=/usr/bin/docker-compose down
TimeoutStartSec=0

[Install]
WantedBy=default.target
EOFSERVICE

systemctl --user daemon-reload
systemctl --user enable searxng.service
echo -e "${GREEN}[✓]${NC} Auto-inicio de SearXNG configurado"

# 5. Iniciar SearXNG
echo -e "${YELLOW}[5/6]${NC} Iniciando SearXNG..."

if groups | grep -q docker; then
    cd "$HOME/searxng"
    docker-compose up -d
    echo -e "${GREEN}[✓]${NC} SearXNG iniciado"
else
    echo -e "${YELLOW}[!]${NC} Necesitas cerrar sesión primero para usar Docker"
    echo -e "${YELLOW}[!]${NC} Después ejecuta: systemctl --user start searxng.service"
fi

# 6. Verificar instalación
echo -e "${YELLOW}[6/6]${NC} Verificando instalación..."
sleep 2

if ~/.local/bin/claude-check &>/dev/null; then
    echo -e "${GREEN}[✓]${NC} Verificación exitosa"
else
    echo -e "${YELLOW}[!]${NC} Algunas verificaciones fallaron (probablemente Docker requiere re-login)"
fi

echo ""
echo -e "${GREEN}╔═══════════════════════════════════════════════════════════════╗${NC}"
echo -e "${GREEN}║                 ✓ INSTALACIÓN COMPLETADA                      ║${NC}"
echo -e "${GREEN}╚═══════════════════════════════════════════════════════════════╝${NC}"
echo ""
echo -e "${BLUE}Próximos pasos:${NC}"
echo ""
echo -e "  1. ${YELLOW}Recarga tu shell:${NC}"
echo -e "     source ~/.zshrc"
echo ""
echo -e "  2. ${YELLOW}Verifica la instalación:${NC}"
echo -e "     claude-check"
echo ""
echo -e "  3. ${YELLOW}Prueba una búsqueda:${NC}"
echo -e "     s \"arch linux tips\""
echo ""
echo -e "${YELLOW}Nota:${NC} Si Docker no funciona, cierra sesión y vuelve a entrar"
echo ""
